<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c3e50">
<title>Deutscher Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial,sans-serif;background:#f4f4f4;padding:16px;touch-action:manipulation;user-select:none}
.box{background:#fff;max-width:900px;margin:auto;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
button{padding:12px 16px;margin:6px;font-size:18px}
#verbBox{font-size:26px;text-align:center;margin:16px 0}
.sub{font-size:18px;color:#555}
.panel{background:#fafafa;border:1px solid #ccc;border-radius:10px;padding:14px;margin-top:12px;text-align:center}
.nav{display:flex;justify-content:space-between;align-items:center}
@media(max-width:768px){button{font-size:20px;padding:14px 18px}}
</style>
</head>
<body>
<div class="box">
<h2>ðŸ‡©ðŸ‡ª Deutscher Trainer</h2>
<div class="center">
<button id="pldBtn">PLâ€‘D</button>
<button id="dplBtn">Dâ€‘PL</button>
<button id="testBtn">ðŸ§ª Test OFF</button>
</div>
<div id="panel" class="panel" style="display:none">
<div class="nav">
<button onclick="prev()">L</button>
<div>
<div id="v1"></div>
<div id="v2" class="sub"></div>
<div id="v3" class="sub"></div>
<div id="v4" class="sub"></div>
</div>
<button onclick="next()">R</button>
</div>
<div style="margin-top:10px;font-size:14px;color:#777">
<span id="prev3"></span> <b>â€¦</b> <span id="next3"></span>
</div>
</div>
</div>
<script>
const synth = window.speechSynthesis;

let data = {};
let list = [];
let i = 0;
let mode = null;
let timer = null;
let test = false;

// ---------- LOAD DATA ----------
async function load(){
  data = await fetch('verben.json').then(r => r.json());
  list = Object.keys(data);
  console.log("Loaded verbs:", data);
}

// ---------- SAFE SPEECH ----------
function speakSequence(sequence){
  if(!sequence || !sequence.length) return;

  speechSynthesis.cancel();
  let index = 0;

  function next(){
    if(index >= sequence.length) return;
    const { text, lang } = sequence[index++];
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.onend = next;
    speechSynthesis.speak(u);
  }

  next();
}

function speakPLD(v){
  speakSequence([
    { text: v.pl, lang: "pl-PL" },
    { text: v.de, lang: "de-DE" },
    { text: v["PRÃ„TERITUM"], lang: "de-DE" },
    { text: v["PERFEKT"], lang: "de-DE" }
  ]);
}

function speakDPL(v){
  speakSequence([
    { text: v.de, lang: "de-DE" },
    { text: v.pl, lang: "pl-PL" },
    { text: v["PRÃ„TERITUM"], lang: "de-DE" },
    { text: v["PERFEKT"], lang: "de-DE" }
  ]);
}

// ---------- RENDER ----------
function render(){
  const k = list[i];
  const v = data[k];

  if(mode === "PL-D"){
    v1.textContent = v.pl;
    v2.textContent = v.de;
    v3.textContent = "PrÃ¤teritum: " + v["PRÃ„TERITUM"];
    v4.textContent = "Perfekt: " + v["PERFEKT"];
    if(!test) speakPLD(v);
  }

  if(mode === "D-PL"){
    v1.textContent = v.de;
    v2.textContent = v.pl;
    v3.textContent = "PrÃ¤teritum: " + v["PRÃ„TERITUM"];
    v4.textContent = "Perfekt: " + v["PERFEKT"];
    if(!test) speakDPL(v);
  }

  renderSide();
}

// ---------- SIDE LIST ----------
function renderSide(){
  prev3.textContent = list.slice(Math.max(0,i-3), i).join(" Â· ");
  next3.textContent = list.slice(i+1, i+4).join(" Â· ");
}

// ---------- NAV ----------
function prev(){ i = (i - 1 + list.length) % list.length; render(); }
function next(){ i = (i + 1) % list.length; render(); }

// ---------- LOOP ----------
function loop(){ stop(); timer = setInterval(next, 4500); }
function stop(){ if(timer){ clearInterval(timer); timer=null; } speechSynthesis.cancel(); }

// ---------- BUTTONS ----------
pldBtn.onclick = () => {
  speechSynthesis.speak(new SpeechSynthesisUtterance(""));
  toggle("PL-D");
};

dplBtn.onclick = () => {
  speechSynthesis.speak(new SpeechSynthesisUtterance(""));
  toggle("D-PL");
};

testBtn.onclick = () => {
  test = !test;
  testBtn.textContent = test ? "ðŸ§ª Test ON" : "ðŸ§ª Test OFF";
  if(!test) loop(); else stop();
};

function toggle(m){
  if(mode === m){
    mode = null;
    panel.style.display = "none";
    stop();
    return;
  }
  mode = m;
  panel.style.display = "block";
  i = 0;
  render();
  loop();
}

load();
</script>
</body>
</html>
